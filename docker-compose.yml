services:
  # ── PostgreSQL database ────────────────────────────────────────────────────
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-ph_advisor}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ph_advisor}
      POSTGRES_DB: ${POSTGRES_DB:-ph_advisor}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ph_advisor}"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ── Redis (message broker + result backend) ────────────────────────────────
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ── Flask web UI ───────────────────────────────────────────────────────────
  web:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${WEB_PORT:-5000}:5000"
    environment: &shared-env
      # ── LLM (required) ────────────────────────────────────────────────────
      OPENAI_API_KEY: ${OPENAI_API_KEY:?Set OPENAI_API_KEY in .env}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      OPENAI_TEMPERATURE: ${OPENAI_TEMPERATURE:-0.0}
      # ── Web search (optional) ─────────────────────────────────────────────
      TAVILY_API_KEY: ${TAVILY_API_KEY:-}
      TAVILY_MAX_RESULTS: ${TAVILY_MAX_RESULTS:-5}
      TAVILY_SEARCH_DEPTH: ${TAVILY_SEARCH_DEPTH:-basic}
      # ── Database — always Postgres inside Docker ──────────────────────────
      DB_BACKEND: postgres
      POSTGRES_DSN: postgresql://${POSTGRES_USER:-ph_advisor}:${POSTGRES_PASSWORD:-ph_advisor}@db:5432/${POSTGRES_DB:-ph_advisor}
      # ── Redis ─────────────────────────────────────────────────────────────
      REDIS_URL: redis://redis:6379/0
      # ── API base URLs ─────────────────────────────────────────────────────
      DRAGONFI_BASE_URL: ${DRAGONFI_BASE_URL:-https://api.dragonfi.ph/api/v2}
      PSE_EDGE_BASE_URL: ${PSE_EDGE_BASE_URL:-https://edge.pse.com.ph}
      TRADINGVIEW_SCANNER_URL: ${TRADINGVIEW_SCANNER_URL:-https://scanner.tradingview.com/philippines/scan}
      # ── HTTP ──────────────────────────────────────────────────────────────
      HTTP_TIMEOUT: ${HTTP_TIMEOUT:-15}
      # ── Timezone ──────────────────────────────────────────────────────────
      TIMEZONE: ${TIMEZONE:-Asia/Manila}
      # ── Output directory (bind-mounted to host) ───────────────────────────
      OUTPUT_DIR: /app/output
      # ── Microsoft Entra ID (passkey / OIDC login) ─────────────────────────
      ENTRA_CLIENT_ID: ${ENTRA_CLIENT_ID:-}
      ENTRA_CLIENT_SECRET: ${ENTRA_CLIENT_SECRET:-}
      ENTRA_TENANT_ID: ${ENTRA_TENANT_ID:-common}
      ENTRA_REDIRECT_PATH: ${ENTRA_REDIRECT_PATH:-/auth/callback}
      FLASK_SECRET_KEY: ${FLASK_SECRET_KEY:-ph-stocks-advisor-change-me-in-production}
      # ── Google OAuth2 (social login) ──────────────────────────────────────
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_REDIRECT_PATH: ${GOOGLE_REDIRECT_PATH:-/auth/google/callback}
      # ── LangSmith (optional) ──────────────────────────────────────────────
      LANGSMITH_API_KEY: ${LANGSMITH_API_KEY:-}
      LANGSMITH_TRACING: ${LANGSMITH_TRACING:-false}
      LANGSMITH_PROJECT: ${LANGSMITH_PROJECT:-ph-stocks-advisor}
    volumes:
      - ./output:/app/output
    entrypoint: ["ph-advisor-web"]
    command: ["--host", "0.0.0.0", "--port", "5000"]

  # ── Celery worker (runs analyses in the background) ────────────────────────
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      <<: *shared-env
    volumes:
      - ./output:/app/output
    entrypoint: ["celery"]
    command: ["-A", "ph_stocks_advisor.web.celery_app:celery_app", "worker", "--loglevel=info", "--concurrency=2"]

  # ── PH Stocks Advisor CLI (one-shot analysis) ─────────────────────────────
  advisor:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      db:
        condition: service_healthy
    environment:
      <<: *shared-env
    volumes:
      - ./output:/app/output
    # Default: analyse TEL. Override with:
    #   docker compose run --rm advisor SM BDO --pdf
    command: ["TEL"]

  # ── SQLAdmin (database admin panel) ────────────────────────────────────────
  admin:
    build:
      context: ./admin
      dockerfile: Dockerfile
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "${ADMIN_PORT:-8085}:8085"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-ph_advisor}:${POSTGRES_PASSWORD:-ph_advisor}@db:5432/${POSTGRES_DB:-ph_advisor}
      ADMIN_SECRET_KEY: ${ADMIN_SECRET_KEY:-sqladmin-dev-secret-change-me}
    restart: unless-stopped

volumes:
  pgdata:
