services:
  # ── PostgreSQL database ────────────────────────────────────────────────────
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-ph_advisor}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ph_advisor}
      POSTGRES_DB: ${POSTGRES_DB:-ph_advisor}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - ./db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ph_advisor}"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ── PH Stocks Advisor CLI ─────────────────────────────────────────────────
  advisor:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      db:
        condition: service_healthy
    environment:
      # ── LLM (required) ────────────────────────────────────────────────────
      OPENAI_API_KEY: ${OPENAI_API_KEY:?Set OPENAI_API_KEY in .env}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      OPENAI_TEMPERATURE: ${OPENAI_TEMPERATURE:-0.0}
      # ── Web search (optional) ─────────────────────────────────────────────
      TAVILY_API_KEY: ${TAVILY_API_KEY:-}
      TAVILY_MAX_RESULTS: ${TAVILY_MAX_RESULTS:-5}
      TAVILY_SEARCH_DEPTH: ${TAVILY_SEARCH_DEPTH:-basic}
      # ── Database — always Postgres inside Docker ──────────────────────────
      DB_BACKEND: postgres
      POSTGRES_DSN: postgresql://${POSTGRES_USER:-ph_advisor}:${POSTGRES_PASSWORD:-ph_advisor}@db:5432/${POSTGRES_DB:-ph_advisor}
      # ── API base URLs ─────────────────────────────────────────────────────
      DRAGONFI_BASE_URL: ${DRAGONFI_BASE_URL:-https://api.dragonfi.ph/api/v2}
      PSE_EDGE_BASE_URL: ${PSE_EDGE_BASE_URL:-https://edge.pse.com.ph}
      TRADINGVIEW_SCANNER_URL: ${TRADINGVIEW_SCANNER_URL:-https://scanner.tradingview.com/philippines/scan}
      # ── HTTP ──────────────────────────────────────────────────────────────
      HTTP_TIMEOUT: ${HTTP_TIMEOUT:-15}
      # ── Timezone ──────────────────────────────────────────────────────────
      TIMEZONE: ${TIMEZONE:-Asia/Manila}
      # ── Output directory (bind-mounted to host) ───────────────────────────
      OUTPUT_DIR: /app/output
      # ── LangSmith (optional) ──────────────────────────────────────────────
      LANGCHAIN_TRACING_V2: ${LANGCHAIN_TRACING_V2:-false}
      LANGCHAIN_API_KEY: ${LANGCHAIN_API_KEY:-}
      LANGCHAIN_PROJECT: ${LANGCHAIN_PROJECT:-ph-stocks-advisor}
    volumes:
      - ./output:/app/output
    # Default: analyse TEL. Override with:
    #   docker compose run advisor SM BDO --pdf
    command: ["TEL"]
